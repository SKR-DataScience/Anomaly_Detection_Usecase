# 거리기반 이상탐지 - 3 Sigma Rule, Box plot 

</br>

## 1. 3-Sigma Rule 이상탐지
</br>

> ### 정의
* **3-Sigma Rule** : 통계학에서 정규분포를 나타내는 규칙으로, 평균에서 양쪽으로 표준편차의 3배 범위에 거의 모든 데이터(99.7%)가 포함됨

  ![3Sigma](https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Standard_deviation_diagram.svg/350px-Standard_deviation_diagram.svg.png)
  - 데이터의 산포를 파악하기 위한 개념으로 많이 활용됨
  - 평균 기준으로 3*Sigma를 더하고 뺀 값이 각각 'UCL(Upper Control Limit)' / 'LCL(Lower Control Limit)'
  - **표준편차에 곱하는 계수가 꼭 3으로 고정은 아님. 필요에 따라 다르게 기준을 가져갈 수 있다**
  
    |범위|차지하는 비율|벗어날 확률|벗어날 확률의 비유적 표현|
    |:---|:---|:---|:---|
    |μ ± 1σ|68.26894%|1/3|7일(일주일) 중 이틀|
    |μ ± 2σ|95.44997%|1/21|6주(겨울방학 기간) 중 이틀|
    |μ ± 3σ|99.73002%|1/370|2년(군복무 기간) 중 이틀|
    |μ ± 4σ|99.99366%|1/15,787|86년(2020년 기준 한국여성 기대수명) 중 이틀|
    |μ ± 5σ|99.99994%|1/1,744,278|12,000년(신석기시대 이래)에 이틀|
    |μ ± 6σ|99.99999%|1/506,842,372|140만년(사람속(Homo)이 불을 최초로 사용한 이래)에 이틀|

</br>

> ### 장단점
* 구현하기 쉽지만, 정규분포가 가정되어야 하고 다차원 데이터에 적용하기 어려움

|장점|단점|
|:---|:---|
|- **구현하기 매우 쉬움** </br> - 명확한 기준 설정, 재학습 필요 없음 |**-정규분포가 가정되어야 함** </br> -다차원 데이터에 적용하기 어려움 </br> (단변량 데이터에만 적용 가능해 **변수간 상호관계 파악 어려움**) </br> **-이상치에 민감함** </br>(평균을 구할 때부터 이상치 포함되어 계산, 이상치가 너무 크거나 많으면 cut이 높아질 수 있음) </br> (그래서 정규분포가 가정되어야 하는것인가) |

</br>

> ### 사용방법
* 데이터의 분포를 정규분포로 가정 (정규성 검정 필요)
* 평균으로부터 양쪽으로 (표준편차*Sigma계수) 범위를 벗어나면 이상치로 판단

</br>

> ### 현업사례
* 공정 센서 데이터 이상탐지
* 검사 및 측정 데이터 이상탐지

</br>
</br>

## 2. Box plot 활용 이상탐지 (IQR 활용)
</br>

> ### 정의
* 사실상 IQR을 활용한 이상치 탐지이며, Box plot을 통해 눈으로 확인할 수 있음
* **IQR** : Inter Quartile Range(사분위수 범위). 데이터를 순서대로 나열했을 때 25%지점(Q1)~75%지점(Q3) 데이터의 차이를 의미
  - Maximum = Q3+1.5*IQR, Minimum = Q1-1.5*IQR로 두고, 해당 범위를 벗어나는 경우 이상치로 판단
  ![Box Plot](https://drive.google.com/uc?id=1pQT3D1JhZXEL5Cc79fZJAd5F3LORGezM)
</br>

* **왜 하필 1.5를 곱하는가?** (출처: https://djccnt15.github.io/dataanalysis/iqr_method/)
  * ![정규분포](https://djccnt15.github.io/assets/img/posts/Normal-Distribution-curve.jpg)
  * **정규분포에서,** 평균 기준 +/-3*Sigma 값을 정상 데이터로 본다.
  * 이 때 Q1과 Q3은 각각 +/-0.675*Sigma에 위치함
  * Q1과 Q3을 기준으로 IQR에 일정 계수를 곱한 다음 범위를 구해보면,
    * 계수가 1일 때(+/-1*IQR): 정상 데이터의 범위가 +/-2.025*Sigma 수준으로, 3-Sigma rule에 못 미침
    * 계수가 2일 때(+/-2*IQR): 정상 데이터의 범위가 +/-3.375*Sigma 수준으로, 3-Sigma rule에 비해 이상 데이터가 범위가 너무 작음
    * 계수가 1.5일 때(+/-1.5*IQR): 정상 데이터의 범위가 +/-2.7*Sigma 수준으로, 3-Sigma rule에 어느정도 근접함
    * 정확히는 계수가 1.7일 때 +/-2.97*Sigma 수준으로 가장 근접하지만, 계산의 편의성 등을 고려해 1.5로 픽스함.


</br>

> ### 장단점
* 데이터를 눈으로 직접 보고 이상치를 설명하기 좋은 방법, 그러나 정확한 분포를 확인하기는 어려움

|장점|단점|
|:---|:---|
|- plot으로 데이터를 눈으로 보며 범위 파악 (현업에게 설명하기도 좋음) </br> - 통계적 이상치(Outlier)가 있는지 확인 가능 </br> - 다양한 정보를 쉽게 표현 가능 </br> **- 평균이 아닌 사분위수를 기준으로 하여 3Sigma rule에 비해 이상치에 덜 민감함** |- 위치 정보만 표현, 정확한 분포는 확인 어려움 </br> -box plot 가운데 선을 평균으로 오해하기 쉬움 |

</br>

> ### 사용방법
* 각 사분위수를 계산하고, IQR을 계산하여 1Q와 3Q 값에 각각 빼고 더해줌 (Minimum, Maximum 값. Whisker라고도 함)
* Minimum, Maximum 값을 넘는 경우 이상치로 판단 (Boxplot에서 point 표시)

</br>

> ### 현업사례
* EDA 단계에서 많이 사용
* 공정 센서 데이터 이상탐지
* 검사 및 측정 데이터 이상탐지

